<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Trading Journal</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e40af 50%, #0f172a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CONFIG = {
            BOT_TOKEN: '8489930334:AAFpZpASPCcR6mEQhar72-9Nb3pYZJwOqXE',
            CHAT_ID: '5330125827',
            SHEETS_API_URL: 'https://script.google.com/macros/s/AKfycbxEpI7S1EBFcjmsixegY_ZNatix2GSOMNjLyvtib3NrEHJqzo5RsBT8xleJPJa_S1ko/exec'
        };

        function TradingJournal() {
            const [trades, setTrades] = useState([]);
            const [activeTab, setActiveTab] = useState('entry');
            const [selectedTrade, setSelectedTrade] = useState(null);

            useEffect(() => {
                const saved = localStorage.getItem('pro-trades');
                if (saved) setTrades(JSON.parse(saved));
            }, []);

            const saveTrades = (newTrades) => {
                setTrades(newTrades);
                localStorage.setItem('pro-trades', JSON.stringify(newTrades));
            };

            const sendTelegram = async (message) => {
                try {
                    const response = await fetch(`https://api.telegram.org/bot${CONFIG.BOT_TOKEN}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: CONFIG.CHAT_ID, text: message, parse_mode: 'HTML' })
                    });
                    return { success: response.ok };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            };

            const saveToSheets = async (trade, action = 'addTrade') => {
                try {
                    const params = new URLSearchParams({ action, data: JSON.stringify(trade) });
                    const response = await fetch(`${CONFIG.SHEETS_API_URL}?${params.toString()}`, { method: 'GET' });
                    const text = await response.text();
                    console.log('Sheets response:', text);
                    return JSON.parse(text);
                } catch (error) {
                    return { success: false, error: error.message };
                }
            };

            const formatTime = () => new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            const calculateHoldingTime = (entryTs, exitTs) => {
                const diff = exitTs - entryTs;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                if (hours > 24) return `${Math.floor(hours / 24)}d ${hours % 24}h`;
                if (hours > 0) return `${hours}h ${minutes}m`;
                return `${minutes}m`;
            };

            const exportToCSV = () => {
                if (trades.length === 0) return alert('No trades to export!');
                const headers = ['ID', 'Symbol', 'Type', 'Timeframe', 'Entry', 'Exit', 'Quantity', 'Target', 'SL', 'Entry Time', 'Exit Time', 'Status', 'P&L', 'R-Multiple', 'Holding', 'Strategy', 'Quality', 'Emotion', 'Notes'];
                const rows = trades.map(t => [t.id, t.symbol, t.type, t.timeframe, t.entry, t.exitPrice || '', t.quantity, t.target, t.stoploss, t.entryTime, t.exitTime || '', t.status, t.pnl || 0, t.rMultiple || 0, t.holdingTime || '', t.strategy || '', t.setupQuality || '', t.emotionBefore || '', t.notes || '']);
                const csv = [headers, ...rows].map(r => r.map(c => String(c).includes(',') ? `"${c}"` : c).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `trades_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                alert('‚úÖ CSV exported!');
            };

            const stats = React.useMemo(() => {
                const openTrades = trades.filter(t => t.status === 'OPEN');
                const closedTrades = trades.filter(t => t.status === 'CLOSED');
                const today = new Date().toDateString();
                const todayTrades = trades.filter(t => new Date(t.entryTime).toDateString() === today);
                const todayPnl = todayTrades.filter(t => t.status === 'CLOSED').reduce((sum, t) => sum + (t.pnl || 0), 0);
                const winRate = closedTrades.length ? ((closedTrades.filter(t => t.pnl > 0).length / closedTrades.length) * 100).toFixed(1) : '0';
                const avgR = closedTrades.length ? (closedTrades.reduce((sum, t) => sum + (t.rMultiple || 0), 0) / closedTrades.length).toFixed(2) : '0.00';
                const grossWin = closedTrades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0);
                const grossLoss = Math.abs(closedTrades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0));
                const profitFactor = grossLoss > 0 ? (grossWin / grossLoss).toFixed(2) : closedTrades.length ? '‚àû' : '0';
                const bestR = closedTrades.length ? Math.max(...closedTrades.map(t => t.rMultiple || 0)).toFixed(2) : '0.00';
                return { openTrades, closedTrades, todayPnl, winRate, avgR, profitFactor, bestR, totalClosed: closedTrades.length };
            }, [trades]);

            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-2xl mx-auto">
                        <Header stats={stats} exportToCSV={exportToCSV} />
                        <Tabs activeTab={activeTab} setActiveTab={setActiveTab} />
                        {activeTab === 'entry' && <EntryForm trades={trades} saveTrades={saveTrades} sendTelegram={sendTelegram} saveToSheets={saveToSheets} formatTime={formatTime} />}
                        {activeTab === 'exit' && <ExitTab trades={trades} saveTrades={saveTrades} sendTelegram={sendTelegram} saveToSheets={saveToSheets} formatTime={formatTime} calculateHoldingTime={calculateHoldingTime} selectedTrade={selectedTrade} setSelectedTrade={setSelectedTrade} />}
                        {activeTab === 'analytics' && <Analytics trades={trades} />}
                        {activeTab === 'summary' && <Summary trades={trades} sendTelegram={sendTelegram} />}
                    </div>
                </div>
            );
        }

        function Header({ stats, exportToCSV }) {
            return (
                <div className="bg-white/10 backdrop-blur-lg rounded-2xl shadow-2xl p-6 mb-4">
                    <div className="flex justify-between items-center mb-4">
                        <h1 className="text-3xl font-bold text-white">üìä Trading Journal</h1>
                        <button onClick={exportToCSV} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">üì• Export</button>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <MetricCard label="Open" value={stats.openTrades.length} color="text-yellow-300" />
                        <MetricCard label="Today P&L" value={`‚Çπ${stats.todayPnl.toFixed(0)}`} color={stats.todayPnl >= 0 ? 'text-green-300' : 'text-red-300'} />
                        <MetricCard label="Win Rate" value={`${stats.winRate}%`} color="text-blue-300" />
                        <MetricCard label="Avg R" value={`${stats.avgR}R`} color="text-purple-300" />
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        <MetricCard label="Profit Factor" value={stats.profitFactor} color="text-white" />
                        <MetricCard label="Total Trades" value={stats.totalClosed} color="text-white" />
                        <MetricCard label="Best R" value={`${stats.bestR}R`} color="text-green-300" />
                    </div>
                </div>
            );
        }

        function MetricCard({ label, value, color }) {
            return (
                <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
                    <div className="text-white/60 text-xs">{label}</div>
                    <div className={`${color} text-2xl font-bold`}>{value}</div>
                </div>
            );
        }

        function Tabs({ activeTab, setActiveTab }) {
            const tabs = ['entry', 'exit', 'analytics', 'summary'];
            const labels = { entry: 'Entry', exit: 'Exit', analytics: 'Analytics', summary: 'Summary' };
            return (
                <div className="flex gap-2 mb-4">
                    {tabs.map(tab => (
                        <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-3 rounded-xl font-semibold ${activeTab === tab ? 'bg-blue-500 text-white' : 'bg-white/10 text-white/70'}`}>
                            {labels[tab]}
                        </button>
                    ))}
                </div>
            );
        }

        function EntryForm({ trades, saveTrades, sendTelegram, saveToSheets, formatTime }) {
            const [form, setForm] = useState({ symbol: '', type: 'BUY', timeframe: 'Intraday', entry: '', quantity: '', target: '', stoploss: '', strategy: '', setupQuality: 5, emotionBefore: '', notes: '' });
            const [loading, setLoading] = useState(false);
            const [risk, setRisk] = useState(null);

            useEffect(() => {
                if (form.entry && form.stoploss && form.target && form.quantity) {
                    const entry = parseFloat(form.entry);
                    const sl = parseFloat(form.stoploss);
                    const tgt = parseFloat(form.target);
                    const qty = parseInt(form.quantity);
                    const riskPer = Math.abs(entry - sl);
                    const rewardPer = Math.abs(tgt - entry);
                    setRisk({ totalRisk: riskPer * qty, rrRatio: (rewardPer / riskPer).toFixed(2) });
                } else setRisk(null);
            }, [form.entry, form.stoploss, form.target, form.quantity]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!form.symbol || !form.entry || !form.quantity || !form.target || !form.stoploss) return alert('Fill all fields!');
                setLoading(true);
                const trade = { id: Date.now(), ...form, entry: parseFloat(form.entry), quantity: parseInt(form.quantity), target: parseFloat(form.target), stoploss: parseFloat(form.stoploss), entryTime: formatTime(), entryTimestamp: Date.now(), status: 'OPEN', pnl: 0, rMultiple: 0, totalRisk: risk?.totalRisk || 0, rrRatio: risk?.rrRatio || 0 };
                await saveToSheets(trade);
                await sendTelegram(`üü¢ TRADE ENTRY\n\nüìä ${trade.symbol} ${trade.type}\nüí∞ Entry: ‚Çπ${trade.entry}\nüéØ Target: ‚Çπ${trade.target}\nüõë SL: ‚Çπ${trade.stoploss}\nüì¶ Qty: ${trade.quantity}\n\nRisk: ‚Çπ${trade.totalRisk.toFixed(2)} | R:R 1:${trade.rrRatio}\nStrategy: ${trade.strategy}\n‚è∞ ${trade.entryTime}`);
                saveTrades([...trades, trade]);
                setForm({ symbol: '', type: 'BUY', timeframe: 'Intraday', entry: '', quantity: '', target: '', stoploss: '', strategy: '', setupQuality: 5, emotionBefore: '', notes: '' });
                setRisk(null);
                setLoading(false);
                alert('‚úÖ Trade logged!');
            };

            return (
                <form onSubmit={handleSubmit} className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 space-y-4">
                    <h2 className="text-xl font-bold text-white">üü¢ New Trade</h2>
                    <input type="text" placeholder="Symbol" value={form.symbol} onChange={(e) => setForm({ ...form, symbol: e.target.value.toUpperCase() })} className="w-full p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    <div className="grid grid-cols-2 gap-4">
                        <select value={form.type} onChange={(e) => setForm({ ...form, type: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white border border-white/20">
                            <option value="BUY">BUY</option>
                            <option value="SELL">SELL</option>
                        </select>
                        <select value={form.timeframe} onChange={(e) => setForm({ ...form, timeframe: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white border border-white/20">
                            <option value="Intraday">Intraday</option>
                            <option value="Swing">Swing</option>
                            <option value="Positional">Positional</option>
                        </select>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <input type="number" step="0.01" placeholder="Entry" value={form.entry} onChange={(e) => setForm({ ...form, entry: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                        <input type="number" placeholder="Quantity" value={form.quantity} onChange={(e) => setForm({ ...form, quantity: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <input type="number" step="0.01" placeholder="Target" value={form.target} onChange={(e) => setForm({ ...form, target: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                        <input type="number" step="0.01" placeholder="Stop Loss" value={form.stoploss} onChange={(e) => setForm({ ...form, stoploss: e.target.value })} className="p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    </div>
                    <select value={form.strategy} onChange={(e) => setForm({ ...form, strategy: e.target.value })} className="w-full p-3 rounded-lg bg-white/20 text-white border border-white/20">
                        <option value="">Strategy</option>
                        <option value="ORB">ORB</option>
                        <option value="Breakout">Breakout</option>
                        <option value="EMA">EMA Crossover</option>
                        <option value="VWAP">VWAP Bounce</option>
                    </select>
                    <textarea placeholder="Notes" value={form.notes} onChange={(e) => setForm({ ...form, notes: e.target.value })} rows="2" className="w-full p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    {risk && (
                        <div className="bg-yellow-500/20 border border-yellow-500/50 rounded-lg p-4">
                            <div className="text-yellow-200 font-semibold mb-2">üìä Analysis</div>
                            <div className="grid grid-cols-2 gap-2 text-sm text-yellow-100">
                                <div>Risk: ‚Çπ{risk.totalRisk.toFixed(2)}</div>
                                <div>R:R: 1:{risk.rrRatio}</div>
                            </div>
                        </div>
                    )}
                    <button type="submit" disabled={loading} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg">
                        {loading ? '‚è≥ Saving...' : '‚úÖ Log Entry'}
                    </button>
                </form>
            );
        }

        function ExitTab({ trades, saveTrades, sendTelegram, saveToSheets, formatTime, calculateHoldingTime, selectedTrade, setSelectedTrade }) {
            const openTrades = trades.filter(t => t.status === 'OPEN');
            if (selectedTrade) return <ExitForm selectedTrade={selectedTrade} setSelectedTrade={setSelectedTrade} trades={trades} saveTrades={saveTrades} sendTelegram={sendTelegram} saveToSheets={saveToSheets} formatTime={formatTime} calculateHoldingTime={calculateHoldingTime} />;
            return (
                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6">
                    <h2 className="text-xl font-bold text-white mb-4">üî¥ Open Positions</h2>
                    {openTrades.length === 0 ? <p className="text-white/60 text-center py-8">No open trades</p> : (
                        <div className="space-y-3">
                            {openTrades.map(t => (
                                <div key={t.id} className="bg-white/10 rounded-lg p-4 border border-white/20">
                                    <div className="flex justify-between mb-2">
                                        <div><div className="text-white font-bold text-lg">{t.symbol}</div><div className="text-white/60 text-sm">{t.type} ‚Ä¢ {t.strategy}</div></div>
                                        <div className={`px-2 py-1 rounded text-xs font-bold ${t.type === 'BUY' ? 'bg-green-500/20 text-green-300' : 'bg-red-500/20 text-red-300'}`}>{t.type}</div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2 text-sm mb-3">
                                        <div><div className="text-white/60">Entry</div><div className="text-white">‚Çπ{t.entry}</div></div>
                                        <div><div className="text-white/60">Target</div><div className="text-green-300">‚Çπ{t.target}</div></div>
                                        <div><div className="text-white/60">SL</div><div className="text-red-300">‚Çπ{t.stoploss}</div></div>
                                    </div>
                                    <button onClick={() => setSelectedTrade(t)} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg">Exit</button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function ExitForm({ selectedTrade, setSelectedTrade, trades, saveTrades, sendTelegram, saveToSheets, formatTime, calculateHoldingTime }) {
            const [exit, setExit] = useState({ exitPrice: '', exitReason: '', lessons: '' });
            const [loading, setLoading] = useState(false);

            const handleExit = async (e) => {
                e.preventDefault();
                if (!exit.exitPrice) return alert('Enter exit price!');
                setLoading(true);
                const exitPrice = parseFloat(exit.exitPrice);
                const pnl = selectedTrade.type === 'BUY' ? (exitPrice - selectedTrade.entry) * selectedTrade.quantity : (selectedTrade.entry - exitPrice) * selectedTrade.quantity;
                const riskPer = Math.abs(selectedTrade.entry - selectedTrade.stoploss);
                const rMultiple = selectedTrade.type === 'BUY' ? (exitPrice - selectedTrade.entry) / riskPer : (selectedTrade.entry - exitPrice) / riskPer;
                const holdingTime = calculateHoldingTime(selectedTrade.entryTimestamp, Date.now());
                const updated = { ...selectedTrade, status: 'CLOSED', exitPrice, exitTime: formatTime(), exitTimestamp: Date.now(), pnl, rMultiple, holdingTime, ...exit };
                await saveToSheets(updated, 'updateTrade');
                await sendTelegram(`${pnl >= 0 ? 'üü¢' : 'üî¥'} TRADE EXIT\n\nüìä ${updated.symbol} ${updated.type}\nüí∞ Entry: ‚Çπ${updated.entry}\nüö™ Exit: ‚Çπ${exitPrice}\n\nüí∏ P&L: ‚Çπ${pnl.toFixed(2)}\nüìä R: ${rMultiple.toFixed(2)}R\n‚è±Ô∏è ${holdingTime}\n\n${exit.exitReason}`);
                saveTrades(trades.map(t => t.id === selectedTrade.id ? updated : t));
                setLoading(false);
                setSelectedTrade(null);
                alert('‚úÖ Exit logged!');
            };

            return (
                <form onSubmit={handleExit} className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 space-y-4">
                    <h2 className="text-xl font-bold text-white">Exit: {selectedTrade.symbol}</h2>
                    <input type="number" step="0.01" placeholder="Exit Price" value={exit.exitPrice} onChange={(e) => setExit({ ...exit, exitPrice: e.target.value })} className="w-full p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    <select value={exit.exitReason} onChange={(e) => setExit({ ...exit, exitReason: e.target.value })} className="w-full p-3 rounded-lg bg-white/20 text-white border border-white/20">
                        <option value="">Exit Reason</option>
                        <option value="Target Hit">üéØ Target Hit</option>
                        <option value="Stop Loss">üõë Stop Loss</option>
                        <option value="Time Exit">‚è∞ Time Exit</option>
                        <option value="Manual">‚úã Manual</option>
                    </select>
                    <textarea placeholder="Lessons" value={exit.lessons} onChange={(e) => setExit({ ...exit, lessons: e.target.value })} rows="2" className="w-full p-3 rounded-lg bg-white/20 text-white placeholder-white/50 border border-white/20" />
                    <div className="flex gap-2">
                        <button type="button" onClick={() => setSelectedTrade(null)} className="flex-1 bg-white/20 text-white font-semibold py-3 rounded-lg">Cancel</button>
                        <button type="submit" disabled={loading} className="flex-1 bg-blue-500 text-white font-bold py-3 rounded-lg">{loading ? '‚è≥ Saving...' : '‚úÖ Log Exit'}</button>
                    </div>
                </form>
            );
        }

        function Analytics({ trades }) {
            const closed = trades.filter(t => t.status === 'CLOSED');
            if (closed.length === 0) return <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6"><h2 className="text-xl font-bold text-white mb-4">üìà Analytics</h2><p className="text-white/60 text-center py-8">No closed trades yet</p></div>;
            const totalPnl = closed.reduce((s, t) => s + (t.pnl || 0), 0);
            const winners = closed.filter(t => t.pnl > 0);
            const losers = closed.filter(t => t.pnl < 0);
            const avgWin = winners.length ? winners.reduce((s, t) => s + t.pnl, 0) / winners.length : 0;
            const avgLoss = losers.length ? Math.abs(losers.reduce((s, t) => s + t.pnl, 0) / losers.length) : 0;
            return (
                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 space-y-4">
                    <h2 className="text-xl font-bold text-white">üìà Analytics</h2>
                    <div className="grid grid-cols-2 gap-4">
                        <MetricCard label="Expectancy" value={`‚Çπ${(totalPnl / closed.length).toFixed(2)}`} color="text-white" />
                        <MetricCard label="Avg Win" value={`‚Çπ${avgWin.toFixed(0)}`} color="text-green-300" />
                        <MetricCard label="Avg Loss" value={`‚Çπ${avgLoss.toFixed(0)}`} color="text-red-300" />
                        <MetricCard label="Total P&L" value={`‚Çπ${totalPnl.toFixed(0)}`} color={totalPnl >= 0 ? 'text-green-300' : 'text-red-300'} />
                    </div>
                    <div className="bg-white/5 rounded-lg p-4">
                        <h3 className="text-white font-semibold mb-3">Recent Trades</h3>
                        {closed.slice(-5).reverse().map(t => (
                            <div key={t.id} className="flex justify-between p-2 bg-white/5 rounded mb-2">
                                <span className="text-white">{t.symbol}</span>
                                <span className={t.pnl >= 0 ? 'text-green-300' : 'text-red-300'}>‚Çπ{t.pnl.toFixed(0)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function Summary({ trades, sendTelegram }) {
            const today = new Date().toDateString();
            const todayTrades = trades.filter(t => new Date(t.entryTime).toDateString() === today);
            return (
                <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-6 space-y-4">
                    <h2 className="text-xl font-bold text-white">üìä Summary</h2>
                    <button onClick={async () => { await sendTelegram(`üìä DAILY SUMMARY\n${new Date().toLocaleDateString()}\n\nTrades: ${todayTrades.length}`); alert('‚úÖ Sent!'); }} className="w-full bg-purple-500 text-white font-bold py-3 rounded-lg">Send Daily Summary</button>
                    <div className="space-y-2">
                        {todayTrades.map(t => (
                            <div key={t.id} className="bg-white/10 rounded-lg p-3 flex justify-between">
                                <div><div className="text-white font-semibold">{t.symbol}</div><div className="text-white/60 text-xs">{t.type}</div></div>
                                <div className={`text-xs px-2 py-1 rounded ${t.status === 'OPEN' ? 'bg-yellow-500/20 text-yellow-300' : 'bg-gray-500/20 text-gray-300'}`}>{t.status}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TradingJournal />, document.getElementById('root'));
    </script>
</body>
</html>
